# 自动更新功能说明
# WaveSpectra2Text 数据同步系统

## 🎯 功能概述

本项目实现了一个智能的数据自动更新系统，当您更新 `data/audio` 目录中的音频文件或 `data/labels.csv` 标签文件时，系统会自动：

1. **检测数据变化**：监控音频文件和标签文件的增删改
2. **更新词汇表**：自动将新标签添加到 `vocab.py` 文件
3. **生成特征文件**：预处理新音频为频谱特征
4. **维护索引**：更新特征文件索引，保持数据一致性

---

## 🔧 使用方法

### 方法1：手动同步（推荐）

```bash
# 一键同步所有数据
python3 simple_auto_update.py

# 或使用完整版（需要pandas）
python3 sync_data.py
```

**适用场景**：
- 添加了新的音频文件
- 修改了标签文件
- 需要一次性同步所有数据

### 方法2：实时监控

```bash
# 启动实时监控（需要pandas）
python3 watch_data_changes.py

# 或使用完整版自动更新系统
python3 auto_update_system.py --mode monitor
```

**适用场景**：
- 开发阶段频繁修改数据
- 需要实时响应数据变化
- 长期运行的数据处理流水线

### 方法3：强制重新处理

```bash
# 强制重新处理所有文件
python3 sync_data.py --force
```

**适用场景**：
- 数据文件损坏需要重建
- 更改了预处理参数
- 需要清理并重新生成所有特征

---

## 📁 监控的文件和目录

### 输入监控
- `data/audio/` - 音频文件目录
  - 支持格式：`.wav`, `.mp3`, `.flac`, `.m4a`, `.aac`, `.ogg`
  - 自动检测：新增、修改、删除
- `data/labels.csv` - 标签文件
  - 格式：`filename,label`
  - 自动检测：内容变化、新标签

### 自动更新的文件
- `vocab.py` - 词汇表文件
  - 自动添加新标签到词汇映射
  - 保持索引连续性
  - 自动备份原文件
- `data/features/` - 特征文件目录
  - 自动生成 `.npy` 特征文件
  - 自动创建 `spectrum_index.csv` 索引
  - 自动清理删除文件对应的特征

---

## 🔄 工作流程

### 1. 数据变化检测
```
音频文件变化 → 计算文件哈希 → 识别新增/修改/删除
标签文件变化 → 解析CSV内容 → 提取新标签
```

### 2. 词汇表更新
```
提取新标签 → 检查词汇表 → 添加新映射 → 备份原文件 → 更新vocab.py
```

### 3. 特征生成
```
新音频文件 → STFT频谱提取 → 保存.npy文件 → 更新索引文件
```

### 4. 数据清理
```
删除的音频 → 删除对应特征 → 更新索引 → 清理缓存
```

---

## 📊 使用示例

### 示例1：添加新音频文件

```bash
# 1. 将新音频文件放入data/audio/目录
cp new_audio.wav data/audio/

# 2. 更新标签文件
echo "new_audio.wav,新标签" >> data/labels.csv

# 3. 运行自动同步
python3 simple_auto_update.py
```

**预期输出**：
```
🔍 检查数据更新...
📁 发现 11 个音频文件
🏷️  发现标签: ['一', '二', '三', ..., '新标签']
🆕 需要添加的新标签: ['新标签']
✅ 词汇表已更新，添加标签: {'新标签'}
📁 备份文件: vocab.py.backup
```

### 示例2：批量添加数据

```bash
# 1. 批量复制音频文件
cp batch_audio/*.wav data/audio/

# 2. 批量更新标签文件（使用脚本或手动编辑）
python3 setup_data.py  # 自动生成标签模板

# 3. 运行同步
python3 simple_auto_update.py
```

### 示例3：实时监控模式

```bash
# 启动监控
python3 watch_data_changes.py

# 在另一个终端添加文件
cp new_file.wav data/audio/
echo "new_file.wav,测试" >> data/labels.csv

# 监控会自动检测并处理
```

---

## ⚙️ 配置选项

### 自动更新系统配置

```python
# 在auto_update_system.py中可配置：
AutoUpdateSystem(
    audio_dir='data/audio',        # 音频目录
    labels_file='data/labels.csv', # 标签文件
    features_dir='data/features',  # 特征目录
    vocab_file='vocab.py',         # 词汇表文件
    log_file='auto_update.log'     # 日志文件
)
```

### 监控间隔设置

```bash
# 设置检查间隔为30秒
python3 auto_update_system.py --mode monitor --interval 30
```

---

## 🔍 故障排除

### 常见问题

#### 1. 词汇表更新失败
```bash
❌ 更新词汇表失败: 未找到词汇表定义
```
**解决方案**：
- 检查 `vocab.py` 文件格式是否正确
- 确保包含 `self.word_to_idx = {` 定义
- 查看备份文件 `vocab.py.backup`

#### 2. 标签文件格式错误
```bash
❌ 读取标签文件失败: 'label' column not found
```
**解决方案**：
- 确保CSV文件包含 `filename` 和 `label` 列
- 检查文件编码为UTF-8
- 运行 `python3 setup_data.py` 重新生成

#### 3. 音频文件处理失败
```bash
❌ 处理文件 test.wav 失败: No module named 'librosa'
```
**解决方案**：
```bash
pip install librosa soundfile
```

### 调试技巧

#### 查看详细日志
```bash
# 查看自动更新日志
tail -f auto_update.log

# 运行测试脚本
python3 test_auto_update.py
```

#### 手动验证
```bash
# 检查词汇表内容
python3 -c "from vocab import vocab; print(vocab.word_to_idx)"

# 检查标签文件
head -10 data/labels.csv

# 检查特征文件
ls -la data/features/
```

---

## 🚀 性能优化

### 大数据集优化

1. **使用预计算模式**：
```bash
# 一次性预处理所有音频
python3 batch_preprocess.py --audio_dir data/audio --output_dir data/features

# 使用预计算特征训练（速度提升5-10倍）
python3 train_scale_1.py --use_precomputed
```

2. **批量处理**：
```bash
# 批量添加文件后再同步
cp batch/*.wav data/audio/
python3 simple_auto_update.py  # 一次性处理所有变化
```

3. **缓存优化**：
- 系统自动缓存已处理的特征文件
- 只有文件变化时才重新处理
- 支持增量更新

---

## 📋 检查清单

### 使用前检查
- [ ] 音频文件已放置在 `data/audio/` 目录
- [ ] 标签文件 `data/labels.csv` 格式正确
- [ ] 已安装必要依赖：`librosa`, `numpy`
- [ ] `vocab.py` 文件存在且格式正确

### 使用后验证
- [ ] 新标签已添加到 `vocab.py`
- [ ] 特征文件已生成在 `data/features/`
- [ ] 索引文件 `spectrum_index.csv` 已更新
- [ ] 备份文件已创建（如有更新）

---

## 🎯 最佳实践

### 1. 数据管理
- 定期备份重要文件
- 使用版本控制管理配置文件
- 保持音频文件命名规范

### 2. 开发流程
```bash
# 推荐的开发流程
1. 添加新音频文件到 data/audio/
2. 更新 data/labels.csv
3. 运行 python3 simple_auto_update.py
4. 验证更新结果
5. 开始训练或推理
```

### 3. 生产环境
- 使用实时监控模式
- 设置合适的检查间隔
- 配置日志文件监控
- 定期清理缓存文件

---

## 📞 技术支持

### 获取帮助
```bash
# 查看帮助信息
python3 simple_auto_update.py --help
python3 auto_update_system.py --help

# 运行测试
python3 test_auto_update.py
python3 test_new_label.py
```

### 功能验证
- 所有自动更新功能都经过测试验证
- 支持增量更新和全量重建
- 兼容现有的训练和推理流程
- 提供完整的错误处理和回滚机制

---

*本自动更新系统为WaveSpectra2Text项目提供了完整的数据管理解决方案，确保数据变化时相关文件的自动同步，大大提升了开发和使用效率。*